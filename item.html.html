<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CoinSprite • Items</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --pad: clamp(12px, 4vw, 28px);
      --pageW: 980px;
      --ease: cubic-bezier(.2,.9,.2,1);
      --bgImg: url("https://i.ibb.co/1tLydhdL/201a90d2455916fa002bee91936bcdd5.jpg");
      --tb-bg: rgba(255,255,255,.72);
      --tb-border: rgba(15,23,42,.12);
      --tb-text: #0f172a;
      --tb-muted: rgba(15,23,42,.70);
      --tb-shadow: 0 10px 28px rgba(2,6,23,.10);
      --accent1:#4f46e5;
      --accent2:#f97316;
      --tb-radius: 999px;
      --radius:16px;
      --bg:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.12);
      --shadow:0 12px 30px rgba(2,6,23,.08);
      --card:#fff;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --tb-bg: rgba(11,18,32,.72);
        --tb-border: rgba(255,255,255,.14);
        --tb-text: #e8eefc;
        --tb-muted: rgba(232,238,252,.75);
        --tb-shadow: 0 10px 28px rgba(0,0,0,.35);
        --accent1:#7c7cff;
        --accent2:#ff9a5f;
        --bg:#0b1220;
        --text:#e2e8f0;
        --muted: rgba(232,238,252,.78);
        --border: rgba(255,255,255,.14);
        --card:#0f172a;
      }
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      padding: var(--pad);
      background-image: var(--bgImg);
      background-repeat: repeat;
      background-size: auto;
      background-position: top left;
      font-family: "Nunito", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .page{
      max-width: var(--pageW);
      margin: 0 auto;
      background: linear-gradient(to bottom, rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.92) 85%, rgba(255,255,255,0) 100%);
      border-radius: 16px;
      padding: var(--pad);
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
    }
    a { color: rgb(213, 103, 0); }
    a:visited { color: rgb(127, 62, 0); }
    a:hover { color: rgb(255, 181, 111); }
    a:active { color: rgb(255, 255, 255); }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 9999;
      isolation: isolate;
      backdrop-filter: blur(14px);
      background:
        linear-gradient(90deg, var(--accent1), var(--accent2)) 0 0/100% 3px no-repeat,
        var(--tb-bg);
      border: 1px solid var(--tb-border);
      border-radius: 16px;
      overflow: visible;
    }
    .topbar-inner{
      max-width: var(--pageW);
      margin: 0 auto;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{ display:flex; align-items:center; gap: 10px; min-width: 150px; }
    .brand-logo{ width: 40px; height: 40px; border-radius: 14px; border: 1px solid var(--tb-border); box-shadow: var(--tb-shadow); object-fit: cover; image-rendering: pixelated; background: rgba(255,255,255,.15); flex: 0 0 auto; }
    .brand b{ display:block; color: var(--tb-text); font-size: 14px; letter-spacing: .2px; font-weight: 900; }
    .brand small{ display:block; margin-top: 2px; color: var(--tb-muted); font-size: 12px; font-weight: 700; }
    .nav{ display:flex; gap: 10px; align-items:center; }
    .topbar a.tab{ color: var(--tb-text) !important; text-decoration:none !important; }
    .tab{ position: relative; font-weight: 900; font-size: 14px; padding: 10px 12px; border-radius: var(--tb-radius); border: 1px solid var(--tb-border); background: rgba(255,255,255,.18); box-shadow: var(--tb-shadow); transition: transform .12s ease, border-color .12s ease; white-space: nowrap; }
    .tab:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--tb-border) 60%, var(--accent1)); }
    .tab::after{ content:""; position:absolute; left: 10px; right: 10px; bottom: 7px; height: 2px; border-radius: 99px; background: linear-gradient(90deg, var(--accent1), var(--accent2)); transform: scaleX(0); transform-origin: left; transition: transform .18s ease; opacity: .9; }
    .tab.active::after{ transform: scaleX(1); }
    .tab.active{ border-color: color-mix(in srgb, var(--accent1) 55%, var(--tb-border)); background: linear-gradient(135deg, color-mix(in srgb, var(--accent1) 16%, transparent), color-mix(in srgb, var(--accent2) 12%, transparent)); }

    .wrap{ max-width: 900px; margin: 0 auto; }
    .title{ font-weight: 900; font-size: 26px; margin: 0 0 8px; letter-spacing: .2px; text-align:center; }
    .subtitle{ margin: 0 0 12px; text-align:center; color: var(--muted); font-weight:800; }
    .searchbar{ position: relative; top: 0; z-index: 10; background: var(--bg); padding: 10px 0 10px; }
    .input{ width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: var(--radius); outline: none; font-size: 16px; box-shadow: var(--shadow); }
    .input:focus{ border-color: rgba(59,130,246,.45); box-shadow: 0 0 0 4px rgba(59,130,246,.12), var(--shadow); }
    .meta{ margin-top: 10px; font-size: 14px; color: var(--muted); display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: rgba(2,6,23,.02); font-weight: 800; }

    .filter-dd{ position: relative; margin-top: 12px; }
    .filter-toggle{ appearance:none; -webkit-appearance:none; display:flex; align-items:center; justify-content:space-between; gap:8px; width: 100%; max-width: 560px; padding: 10px 12px; border-radius: var(--radius); border:1px solid var(--border); background: rgba(255,255,255,.9); box-shadow: var(--shadow); font-weight:900; cursor:pointer; color: var(--text); }
    .filter-toggle .caret{ transition: transform .18s var(--ease), opacity .18s var(--ease); opacity:.82; }
    .filter-dd.open .caret{ transform: rotate(180deg); opacity:1; }
    .filter-menu{ display:none; position:absolute; top: calc(100% + 10px); left:0; width: min(760px, calc(100vw - 40px)); border:1px solid var(--border); border-radius: 16px; background: color-mix(in srgb, var(--bg) 94%, transparent); box-shadow: var(--shadow); padding: 14px; z-index: 20; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .filter-dd.open .filter-menu{ display:block; animation: ddPop .16s var(--ease) both; }
    @keyframes ddPop{ from{ opacity:0; transform: translateY(-6px) scale(.98); } to{ opacity:1; transform: translateY(0) scale(1); } }
    .filters{ display:flex; flex-wrap: wrap; gap: 14px; align-items:flex-start; }
    .filter-group{ display:flex; flex-direction:column; gap:8px; }
    .filter-title{ font-size: 13px; font-weight:900; color: var(--muted); text-transform: uppercase; letter-spacing: .3px; }
    .chip-row{ display:flex; gap:8px; flex-wrap: wrap; }
    .chip{ border:1px solid var(--border); background: rgba(2,6,23,.03); padding:7px 10px; border-radius:999px; font-weight:800; color: var(--text); cursor:pointer; transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease; }
    .chip:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--border) 60%, var(--accent1)); box-shadow: 0 12px 24px rgba(15,23,42,.10); }
    .chip.active{ border-color: color-mix(in srgb, var(--accent1) 55%, var(--border)); background: linear-gradient(135deg, color-mix(in srgb, var(--accent1) 16%, transparent), color-mix(in srgb, var(--accent2) 12%, transparent)); }
    .chip.tag{ background: #f87171; color: #fff; border-color: #f43f5e; }
    .chip.tag.active{ background: linear-gradient(135deg, #fda4af, #f43f5e); color:#fff; }

    .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 14px; }
    .card{ border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; background: var(--card); box-shadow: 0 10px 22px rgba(2,6,23,.05); transition: transform .12s ease; display:flex; flex-direction:column; gap:8px; }
    .card:hover{ transform: translateY(-1px); }
    .card-head{ display:flex; gap:10px; align-items:center; }
    .thumb{ width: 64px; height:64px; border-radius: 12px; border:1px solid var(--border); background: rgba(2,6,23,.04); object-fit: contain; image-rendering: pixelated; flex-shrink:0; }
    .name{ margin:0; font-size: 15px; font-weight: 900; line-height:1.2; }
    .rarity-pill{ font-weight:900; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(2,6,23,.03); font-size:12px; }
    .type-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:12px; background: rgba(79,70,229,.08); color:#3730a3; font-weight:800; border:1px solid color-mix(in srgb, var(--accent1) 30%, var(--border)); font-size:12px; }
    .info{ margin:0; color: var(--muted); font-size: 13px; line-height: 1.35; min-height: 2.6em; }
    .tag-row{ display:flex; flex-wrap:wrap; gap:6px; }
    .tag-pill{ background:#ef4444; color:#fff; padding:5px 10px; border-radius:999px; font-weight:900; font-size:12px; border:1px solid rgba(239,68,68,.65); }
    .stat-row{ display:flex; gap:6px; flex-wrap:wrap; }
    .stat{ padding:6px 9px; border-radius:10px; border:1px solid var(--border); background: rgba(2,6,23,.02); font-weight:800; font-size:12px; }

    .detailWrap{ position: fixed; inset:0; background: rgba(0,0,0,.35); display:flex; align-items:flex-start; justify-content:center; padding: 50px 16px; backdrop-filter: blur(3px); z-index: 99999; transition: opacity .18s ease; opacity:0; pointer-events:none; }
    .detailWrap.open{ opacity:1; pointer-events:auto; }
    .detailCard{ max-width: 720px; width: min(720px, 100%); margin-top: 8px; background: var(--card); border-radius: 18px; border:1px solid var(--border); padding: 18px; box-shadow: 0 24px 48px rgba(0,0,0,.18); position:relative; }
    .detailClose{ position:absolute; top:10px; right:10px; width:34px; height:34px; border-radius:12px; border:1px solid var(--border); background: rgba(2,6,23,.03); cursor:pointer; font-weight:900; font-size:16px; }
    .detailTop{ display:flex; gap:18px; flex-wrap:wrap; }
    .detailImgBox{ width:130px; height:130px; border-radius: 16px; border:1px solid var(--border); background: rgba(2,6,23,.03); display:flex; align-items:center; justify-content:center; }
    .detailImg{ max-width:100%; max-height:100%; object-fit: contain; image-rendering: pixelated; }
    .detailName{ margin:0 0 6px; font-size: 24px; font-weight: 900; line-height:1.2; }
    .detailChips, .detailTags{ display:flex; gap:8px; flex-wrap:wrap; }
    .detailList{ margin: 12px 0 0; padding:0; list-style:none; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; }
    .detailItem{ border:1px solid var(--border); border-radius: 12px; padding:10px 12px; background: rgba(2,6,23,.02); font-weight:800; }
    .detailLabel{ display:block; font-size:12px; text-transform: uppercase; letter-spacing:.3px; color: var(--muted); margin-bottom:4px; font-weight:900; }
    .detailValue{ font-size:14px; font-weight:900; color: var(--text); }
    .detailText{ margin:10px 0 0; font-size:14px; line-height:1.45; font-weight:800; color: var(--text); }

    .rare{ color:cyan; font-weight:1000; }
    .epic{ color:rgb(255, 0, 255); font-weight:1000; }
    .legendary{ font-weight:1000; background: linear-gradient(90deg,#ffae00 0%,rgb(255,255,0) 25%,#ffae00 50%,rgb(255,255,0) 75%,#ffae00 100%); background-size: 200% 100%; background-position: 0% 50%; color: transparent; -webkit-background-clip:text; background-clip:text; animation: LegendaryAni 2.2s linear infinite; }
    @keyframes LegendaryAni{ from{background-position:0% 0%;} to{background-position:100% 100%;} }
    .mythical{ font-weight:1000; background: linear-gradient(90deg,rgb(255,0,0) 0%,rgb(255,255,255) 25%,rgb(255,0,0) 50%,rgb(255,255,255) 75%,rgb(255,0,0) 100%); background-size: 200% 100%; background-position: 0% 50%; color: transparent; -webkit-background-clip:text; background-clip:text; animation: MythicalAni 2.2s linear infinite; }
    @keyframes MythicalAni{ from{background-position:0% 0%;} to{background-position:100% 100%;} }
    .secret{ font-weight: 900; --stripe: 13px; --period: calc(var(--stripe) * 2); background-image: repeating-linear-gradient(180deg,#cacaca 0 var(--stripe),#000 var(--stripe) var(--period)); background-size: 100% var(--period); background-position: 50% 0; background-repeat: repeat; -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent; animation: SecretAni 2s linear infinite; will-change: background-position; transform: translateZ(0); }
    @keyframes SecretAni{ to{ background-position: 50% calc(var(--period) * -1); } }

    .empty{ display:none; margin-top: 14px; padding: 14px 16px; border: 1px dashed var(--border); border-radius: 16px; color: var(--muted); font-weight: 800; text-align:center; }

    @media (max-width: 640px){
      body{ padding: 16px; }
      .card-head{ flex-direction: column; align-items:flex-start; }
      .filter-menu{ width: min(100%, calc(100vw - 32px)); }
    }
  </style>
</head>
<body data-page="items">
  <div class="page">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <img class="brand-logo" src="https://i.ibb.co/yn9dt1vx/Normal.png" alt="CoinSprite logo">
          <div>
            <b>CoinSprite</b>
            <small>Discord Bot Wikia</small>
          </div>
        </div>
        <nav class="nav" aria-label="Navigation">
          <a class="tab" href="https://sites.google.com/view/coinsprite/home" data-page="home">Home</a>
          <a class="tab" href="https://sites.google.com/view/coinsprite/hunting" data-page="hunting">Hunting</a>
          <a class="tab" href="https://sites.google.com/view/coinsprite/creature" data-page="creature">Creature</a>
          <span class="tab active" aria-current="page">Item</span>
        </nav>
      </div>
    </header>

    <div class="wrap">
      <h1 class="title">Item Index</h1>
      <p class="subtitle">Search CoinSprite items straight from GitHub.</p>

      <div class="searchbar">
        <input id="search" class="input" type="search" placeholder="Search by item name, rarity, or type..." autocomplete="off" />
        <div class="meta">
          <span class="pill">Showing: <span id="count">0</span></span>
          <span class="pill">Total: <span id="total">0</span></span>
          <span class="pill" id="queryPill" style="display:none;">Query: “<span id="queryText"></span>”</span>
        </div>
        <div class="filter-dd" id="filterDropdown">
          <button id="filterToggle" class="filter-toggle" type="button" aria-expanded="false">
            Filters <span class="caret" aria-hidden="true">▾</span>
          </button>
          <div id="filterMenu" class="filter-menu" role="menu">
            <div class="filters" aria-label="Filters">
              <div class="filter-group">
                <span class="filter-title">Item type</span>
                <div class="chip-row" id="typeFilters"></div>
              </div>
              <div class="filter-group">
                <span class="filter-title">Tags</span>
                <div class="chip-row" id="tagFilters"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty">No items matched your search.</div>
    </div>
  </div>

  <div id="detailWrap" class="detailWrap" hidden>
    <div class="card detailCard">
      <button class="detailClose" id="detailClose" type="button" aria-label="Close">✕</button>
      <div class="detailTop">
        <div class="detailImgBox">
          <img id="detailImg" class="detailImg" alt="" loading="lazy">
        </div>
        <div class="detailMeta">
          <h2 id="detailName" class="detailName">Item</h2>
          <div id="detailChips" class="detailChips"></div>
          <div id="detailTags" class="detailTags"></div>
        </div>
      </div>
      <ul id="detailList" class="detailList"></ul>
      <div id="detailObtainment" class="detailText" style="display:none;"></div>
      <div id="detailUsage" class="detailText" style="display:none;"></div>
    </div>
  </div>

<script>
  const ITEMS_JS_URL = "https://raw.githubusercontent.com/Huy1234secret/CoinSprite/main/src/items.js";
  const TYPE_OPTIONS = ["Container", "Tool/Gear", "Material"];
  const TAG_OPTIONS = ["HUNTING"];
  const TAG_COLOR = "#ef4444";
  const MANUAL_TAGS = {
    ITWoodenSword: ["HUNTING"],
    ITFist: ["HUNTING"],
  };

  const searchInput = document.getElementById("search");
  const grid = document.getElementById("grid");
  const empty = document.getElementById("empty");
  const countEl = document.getElementById("count");
  const totalEl = document.getElementById("total");
  const queryPill = document.getElementById("queryPill");
  const queryText = document.getElementById("queryText");
  const typeFilters = document.getElementById("typeFilters");
  const tagFilters = document.getElementById("tagFilters");
  const filterDropdown = document.getElementById("filterDropdown");
  const filterToggle = document.getElementById("filterToggle");

  const detailWrap = document.getElementById("detailWrap");
  const detailClose = document.getElementById("detailClose");
  const detailImg = document.getElementById("detailImg");
  const detailName = document.getElementById("detailName");
  const detailChips = document.getElementById("detailChips");
  const detailTags = document.getElementById("detailTags");
  const detailList = document.getElementById("detailList");
  const detailObtainment = document.getElementById("detailObtainment");
  const detailUsage = document.getElementById("detailUsage");

  let allItems = [];
  let filteredItems = [];
  const selectedTypes = new Set();
  const selectedTags = new Set();

  function closeFilters(){
    filterDropdown?.classList.remove("open");
    filterToggle?.setAttribute("aria-expanded","false");
  }

  function escapeHTML(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function rarityClass(r){
    const s = String(r || "").toLowerCase();
    if(s.includes("secret")) return "secret";
    if(s.includes("myth")) return "mythical";
    if(s.includes("legend")) return "legendary";
    if(s.includes("epic")) return "epic";
    if(s.includes("rare")) return "rare";
    return "";
  }

  function formatMoney(n){
    const num = Number(n);
    if(!isFinite(num)) return null;
    return num.toLocaleString();
  }

  function stripLabel(text, label){
    if(typeof text !== "string") return text;
    const prefix = `${label}:`;
    if(text.trim().startsWith(prefix)){
      return text.trim().slice(prefix.length).trim();
    }
    return text;
  }

  function extractBalanced(src, start, openChar, closeChar){
    let i = start;
    let depth = 0;
    let inStr = false;
    let strQ = "";
    let esc = false;
    for(; i < src.length; i++){
      const ch = src[i];
      if(inStr){
        if(esc){ esc = false; continue; }
        if(ch === "\\") { esc = true; continue; }
        if(ch === strQ){ inStr = false; strQ = ""; continue; }
        continue;
      }else{
        if(ch === "'" || ch === '"' || ch === "`"){ inStr = true; strQ = ch; continue; }
        if(ch === openChar){ depth++; }
        else if(ch === closeChar){
          depth--;
          if(depth === 0){
            return { text: src.slice(start, i+1), end: i };
          }
        }
      }
    }
    return null;
  }

  async function loadItems(){
    const res = await fetch(ITEMS_JS_URL, { cache: "no-store" });
    if(!res.ok) throw new Error(`Failed to load items (${res.status})`);
    const src = await res.text();
    const idx = src.indexOf("const ITEMS");
    if(idx === -1) return [];
    const arrStart = src.indexOf("[", idx);
    if(arrStart === -1) return [];
    const block = extractBalanced(src, arrStart, "[", "]");
    if(!block) return [];
    const arrText = block.text;
    let parsed = [];
    try{
      parsed = Function(`"use strict"; return (${arrText});`)();
    }catch(err){
      console.error("parse error", err);
      return [];
    }
    if(!Array.isArray(parsed)) return [];
    return parsed.map((it, idx) => {
      const tags = MANUAL_TAGS[it.id]?.slice() || [];
      const searchHaystack = `${it.id || ""} ${it.name || ""} ${it.rarity || ""} ${it.type || ""} ${tags.join(" ")}`.toLowerCase();
      return { ...it, tags, searchHaystack, _uid: `item_${idx}_${(it.name||"").toLowerCase().replace(/\s+/g,"_")}` };
    });
  }

  function renderFilters(){
    typeFilters.innerHTML = TYPE_OPTIONS.map(type => `<button class="chip" type="button" data-type="${type}">${escapeHTML(type)}</button>`).join("");
    tagFilters.innerHTML = TAG_OPTIONS.map(tag => `<button class="chip tag" type="button" data-tag="${tag}">${escapeHTML(tag)}</button>`).join("");

    typeFilters.querySelectorAll("[data-type]").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.type;
        if(selectedTypes.has(type)) selectedTypes.delete(type); else selectedTypes.add(type);
        btn.classList.toggle("active");
        applyFilters();
      });
    });

    tagFilters.querySelectorAll("[data-tag]").forEach(btn => {
      btn.addEventListener("click", () => {
        const tag = btn.dataset.tag;
        if(selectedTags.has(tag)) selectedTags.delete(tag); else selectedTags.add(tag);
        btn.classList.toggle("active");
        applyFilters();
      });
    });
  }

  function render(list){
    filteredItems = list;
    countEl.textContent = list.length;
    if(!list.length){
      grid.innerHTML = "";
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";
    grid.innerHTML = list.map(item => {
      const rarityCls = rarityClass(item.rarity);
      const rarityLabel = item.rarity ? `<span class="rarity-pill"><span class="${rarityCls}">${escapeHTML(item.rarity)}</span></span>` : "";
      const typeLabel = item.type ? `<span class="type-pill">${escapeHTML(item.type)}</span>` : "";
      const info = item.info || "No description available.";
      const valueStat = isFinite(Number(item.value)) ? `<span class="stat">Value: ${escapeHTML(formatMoney(item.value))}</span>` : "";
      const sell = item.sellPrice && Number(item.sellPrice) > 0 ? `Sell: ${formatMoney(item.sellPrice)}` : "Unsellable";
      const sellStat = item.sellPrice !== undefined ? `<span class="stat">${escapeHTML(sell)}</span>` : "";
      const dmgStat = (item.damage && (item.damage.min || item.damage.max)) ? `<span class="stat">Damage: ${escapeHTML(item.damage.min ?? "?")} - ${escapeHTML(item.damage.max ?? "?")}</span>` : "";
      const durStat = item.durability !== undefined ? `<span class="stat">Durability: ${escapeHTML(item.durability === Infinity || item.durability === "Infinity" ? "Infinite" : item.durability)}</span>` : "";
      const tags = (item.tags || []).map(tag => `<span class="tag-pill">${escapeHTML(tag)}</span>`).join("");
      return `
        <article class="card" data-id="${item._uid}" aria-label="${escapeHTML(item.name || "Item")}">
          <div class="card-head">
            <img class="thumb" src="${escapeHTML(item.image || "https://i.ibb.co/bKCL5dR/placeholder.png")}" alt="" loading="lazy">
            <div>
              <h3 class="name">${escapeHTML(item.name || "Item")}</h3>
              <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">${rarityLabel}${typeLabel}</div>
            </div>
          </div>
          <p class="info">${escapeHTML(info)}</p>
          <div class="stat-row">${valueStat}${sellStat}${dmgStat}${durStat}</div>
          <div class="tag-row">${tags}</div>
        </article>`;
    }).join("");

    grid.querySelectorAll(".card").forEach(card => {
      card.addEventListener("click", () => {
        const id = card.getAttribute("data-id");
        const item = filteredItems.find(i => i._uid === id);
        if(item) openDetail(item);
      });
    });
  }

  function applyFilters(){
    const q = searchInput.value.trim().toLowerCase();
    const hasQuery = q.length > 0;
    if(hasQuery){
      queryPill.style.display = "inline-flex";
      queryText.textContent = q;
    }else{
      queryPill.style.display = "none";
    }

    const list = allItems.filter(item => {
      if(hasQuery && !item.searchHaystack.includes(q)) return false;
      if(selectedTypes.size && !selectedTypes.has(item.type)) return false;
      if(selectedTags.size){
        const hasTag = item.tags?.some(t => selectedTags.has(t));
        if(!hasTag) return false;
      }
      return true;
    });
    render(list);
  }

  function formatDurability(dur){
    if(dur === null || dur === undefined) return null;
    if(dur === Infinity || dur === "Infinity" || dur === "INF") return "Infinite";
    const n = Number(dur);
    if(!isFinite(n)) return null;
    return n.toString();
  }

  function openDetail(item){
    detailImg.src = item.image || "";
    detailImg.alt = item.name || "Item";
    detailName.textContent = item.name || "Item";

    const rarityCls = rarityClass(item.rarity);
    const tags = (item.tags || []).map(tag => `<span class="tag-pill">${escapeHTML(tag)}</span>`).join("");
    detailChips.innerHTML = `
      ${item.rarity ? `<span class="pill">Rarity: <b class="${rarityCls}">${escapeHTML(item.rarity)}</b></span>` : ""}
      ${item.type ? `<span class="pill">Type: <b>${escapeHTML(item.type)}</b></span>` : ""}
      ${isFinite(Number(item.value)) ? `<span class="pill">Value: <b>${escapeHTML(formatMoney(item.value))}</b></span>` : ""}
    `;
    detailTags.innerHTML = tags;

    const rows = [];
    if(item.id) rows.push({ label: "Id", value: item.id });
    if(item.name) rows.push({ label: "Name", value: item.name });
    if(item.image) rows.push({ label: "Image", value: item.image });
    if(item.rarity) rows.push({ label: "Rarity", value: item.rarity });
    if(item.type) rows.push({ label: "Type", value: item.type });
    if(isFinite(Number(item.value))) rows.push({ label: "Value", value: formatMoney(item.value) });

    const sell = item.sellPrice && Number(item.sellPrice) > 0 ? formatMoney(item.sellPrice) : "Unsellable";
    if(item.sellPrice !== undefined) rows.push({ label: "SellPrice", value: sell });

    if(item.tradable !== undefined) rows.push({ label: "Tradable", value: item.tradable ? "Yes" : "No" });
    const dur = formatDurability(item.durability);
    if(dur) rows.push({ label: "Durability", value: dur });

    if(item.damage && (item.damage.min !== undefined || item.damage.max !== undefined)){
      const mn = item.damage.min ?? "?";
      const mx = item.damage.max ?? "?";
      rows.push({ label: "Damage", value: `${mn} - ${mx}` });
    }

    if(item.obtainment) rows.push({ label: "Obtainment", value: stripLabel(item.obtainment, "Obtainment") });

    detailList.innerHTML = rows.map(r => `
      <li class="detailItem">
        <span class="detailLabel">${escapeHTML(r.label)}:</span>
        <span class="detailValue">${escapeHTML(r.value)}</span>
      </li>`).join("");

    const obt = stripLabel(item.obtainment, "Obtainment");
    if(obt){
      detailObtainment.style.display = "block";
      detailObtainment.textContent = `Obtainment: ${obt}`;
    }else{
      detailObtainment.style.display = "none";
    }

    const usage = stripLabel(item.usage, "Usage");
    if(usage){
      detailUsage.style.display = "block";
      detailUsage.textContent = `Usage: ${usage}`;
    }else{
      detailUsage.style.display = "none";
    }

    detailWrap.hidden = false;
    requestAnimationFrame(() => detailWrap.classList.add("open"));
  }

  function closeDetail(){
    if(detailWrap.hidden) return;
    detailWrap.classList.remove("open");
    const onEnd = (e) => {
      if(e.target !== detailWrap) return;
      detailWrap.hidden = true;
      detailWrap.removeEventListener("transitionend", onEnd);
    };
    detailWrap.addEventListener("transitionend", onEnd);
  }

  if(detailClose){ detailClose.addEventListener("click", closeDetail); }
  detailWrap?.addEventListener("click", (e) => { if(e.target === detailWrap) closeDetail(); });

  filterToggle?.addEventListener("click", (e) => {
    e.stopPropagation();
    if(!filterDropdown) return;
    const isOpen = filterDropdown.classList.toggle("open");
    filterToggle.setAttribute("aria-expanded", String(isOpen));
  });

  document.addEventListener("click", (e) => {
    if(filterDropdown && !filterDropdown.contains(e.target)){
      closeFilters();
    }
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      closeDetail();
      closeFilters();
    }
  });

  searchInput?.addEventListener("input", applyFilters);

  (async function init(){
    renderFilters();
    try{
      allItems = await loadItems();
      totalEl.textContent = allItems.length;
      applyFilters();
    }catch(err){
      console.error(err);
      empty.textContent = "Unable to load items.";
      empty.style.display = "block";
    }
  })();
</script>
</body>
</html>
